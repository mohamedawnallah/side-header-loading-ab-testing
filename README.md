# Side-Header Loading A/B Testing Experiments
This repository serves as a knowledge base documenting my A/B testing experiments. Here, I explore and evaluate various hypotheses, recording methodologies, results, and insights gained throughout the process.

## Hypotheses: `filters_db/header-index`, `block_headers_bin`, and `reg_filter_headers_bin`

| #  | Block Header in `filters_db/header-index/<16bit_prefix>/block_hashes_group` | Block Header in `block_headers_bin` | Filter Header in `reg_filter_headers_bin` | **Updating `bitcoin` Tip (Manually)** | **Updating `regular` Tip (Manually)** | Description | Default Outcome (`Hâ‚€`) | Accepted or Rejected |
|----|:----------------------------------------:|:-----------------------------------:|:-----------------------------------------:|:-----------------------------------:|:-----------------------------------:|:------------|:----------------------|:---------------------:|
| 1  | âœ”ï¸                                       | âŒ                                  | âŒ                                      | âŒ                                  | âŒ                                  | Block Header exists in `filters_db/header-index` but not in `block_headers_bin` | Error creating chain service: unable to read block header: `EOF` | Accepted            |
| 2  | âŒ                                       | âœ”ï¸                                  | âŒ                                      | âŒ                                  | âŒ                                  | Block Header not in `filters_db/header-index` but exists in `block_headers_bin` | Error creating chain service: target height not found in index  | Accepted            |
| 3  | âŒ                                       | âŒ                                  | âŒ                                      | âŒ                                  | âŒ                                  | Removing Tail Block Header | Error creating chain service: target height not found in index | Accepted            |
| 4  | âŒ                                       | âŒ                                  | âŒ                                      | âœ”ï¸                                  | âŒ                                  | Removing Tail Block Header, updating `bitcoin` chain tip only and not `regular` chain tip | Error creating chain service: target height not found in index | Accepted            |
| 5  | âŒ                                       | âŒ                                  | âŒ                                      | âœ”ï¸                                  | âœ”ï¸                                  | Removing Tail Block Header, updating `bitcoin` and `regular` chain tips | `OK` | Accepted            |
| 6  | âŒ                                       | âŒ                                  | âœ”ï¸                                      | âŒ                                   | âŒ                                  | Removing Head Block Header, not removing Filter Header from store | Error creating chain service: unable to read block header: EOF | Accepted                     |
| 7  | âŒ                                       | âŒ                                  | âŒ                                      | âŒ                                    | âŒ                                    | Removing Head Block Header, removing Filter Header from store | Error creating chain service: unable to read block header: EOF | Accepted                    |
| 8  | âŒ                                       | âŒ                                  | âœ”ï¸                                      | âŒ                                  | âŒ                                   | Removing Middle Header, not removing Filter Header from store | Error creating chain service: unable to read block header: EOF | Accepted                     |
| 9  | âŒ                                       | âŒ                                  | âŒ                                      | âŒ                                   | âŒ                                   | Removing Middle Header, removing Filter Header from store | Error creating chain service: unable to read block header: EOF | Accepted                     |
| 10 | âœ”ï¸                                       | âœ”ï¸                                  | âŒ                                      | âŒ                                  | âŒ                                   | Removing Filter Header from store  | Error creating chain service: unable to read filter header: EOF | Accepted                     |
| 11 | âœ”ï¸                                       | âœ”ï¸                                  | âœ”ï¸                                      | âŒ                                  | âŒ                                  | Header exists in both | `OK` | Accepted            |

## Hypotheses: `filters_db/header-index/regular` and `filters_db/filter-store/regular/<best_block_hash>:<filter>`

| #  | `header-index/regular` (best_block_hash) | `filter-store/regular/<best_block_hash>:<filter>` | **Extend Side-Load** | **Default Outcome (`Hâ‚€`)** | Accepted or Rejected | **Cause of Null Hypothesis Rejection** |
|----|:----------------------------------------:|:------------------------------------------------:|:--------------------:|:--------------------------|:---------------------:|:----------------------------------------|
| 1  | âœ”ï¸                                       | âœ”ï¸                                               | âœ”ï¸                   | `OK` (Block filter for tip exists regardless of `PersistToDisk` config value) | Rejected | When `PersistToDisk` is set to `false` (default), only the genesis block filter is stored in the `filter-store/regular` index. Filters for other blocks will not be persisted. |
| 2  | âœ”ï¸                                       | âŒ                                               | âœ”ï¸                   | Dangling reference error: tip header present but no filter for best block | Rejected | same as ^ |
| 3  | âŒ                                       | âœ”ï¸                                               | âœ”ï¸                   | Orphaned filter error: filter exists for block not referenced as tip | Rejected | same as ^ |
| 4  | âœ”ï¸ (outdated or stale)                   | âœ”ï¸                                               | âœ”ï¸                   | Error: `regular` chain tip is not the best_block hash known | Rejected | The Neutrino chain service acquires a lock on `filters.db` at startup and releases it on exit. If the `bitcoin` and `regular` tips are modified after exit, then on the next startup and sync, they are brought back to a consistent state reflecting the best block hash. |

ğŸ“Œ **Note:** Block filters located in `filters_db/filter-store/regular/<block_hashes>` index are populated during a [`Rescan`](https://github.com/lightninglabs/neutrino?tab=readme-ov-file#rescan) only if the `PersistToDisk` configuration parameter is set to true (default: false) otherwise only the filter header for the genesis block is persisted.

ğŸ“Œ **Note:** We don't need to worry about sending a `getcfilters` message to peers during a extend side-load operation for the best block we know see the above note and a/b testing table ^.


## Hypotheses Regarding Manual Side Loading of Block AND Filter Headers

## Hypotheses Where to Side Loading of Block AND Filter Headers

## Hypotheses When to Side Loading of Block AND Filter Headers

## Conclusions

1. **Permitted Operations:** The permitted operations for side-loading are limited to either no-operation (no-op) or extending. This enforces the monotonicity/append-only property, meaning the state can only remain the same or grow, but never decrease or revert. This restriction is based on mutual trust, as established in the merge intervals algorithm and the process of overlapping checkpointing.
2. **Conjunction Property:** When side-loading block headers for a given range (e.g., blocks M to N), the corresponding filter headers for the same range (M to N) must also be provided. The conjunction property requires that both block headers and filter headers for the specified range are present and valid. The semantic mapping between block headers and filter headers is assumed to be correct and trusted; however, syntactic validation may still be performed during side-loading to ensure structural correctness.
3. **Idempotence Propery:** The idempotence property ensures that performing the same side-loading operation multiple times has the same effect as performing it once. In other words, repeated application of a no-op or extending operation does not result in inconsistencies or unintended changes to the state.
4. **Atomicity Property:** The atomicity property guarantees that each side-loading operation is all-or-nothing: either the entire operation is applied successfully, or no part of it takes effect. This prevents partial application of data, which could result in inconsistencies or corruption.
5. **Chain Tip Consistency:** The chain tip for both `header-index/bitcoin` and `header-index/regular` must always be updated to the best block hash known whenever an extending side-load operation is performed. The value stored should be the double SHA256 (sha256d) of the raw block header data, represented in little-endian format. This ensures that all auxiliary indices and chain state reflect the latest, canonical tip and that downstream operations can reliably reference the most recent block.

## Rationale behind Conclusions

1. **Monotonicity/Append Only Property:** By explicitly disallowing replace, update, and delete operations, and limiting actions to no-op or extending, the system enforces the monotonicity/append-only propertyâ€”the state can only stay the same or grow. This greatly simplifies reasoning about system behavior and prevents inconsistencies or malicious rollbacks during side-loading. Relying on mutual trust and well-defined procedures (such as merge intervals and overlapping checkpointing) enables safe coordination of updates, while minimizing the attack surface and operational complexity.
2. **Conjunction Property for Consistency:**  Requiring both block headers and filter headers together enforces the conjunction property, ensuring data consistency and preventing partial or mismatched data from being introduced during side-loading. This maintains the integrity of the chain state and ensures that all necessary components are available for downstream processing or validation.
3. **Idempotence Propery for Fault Tolerance:** Enforcing the idempotence property means that side-loading operations can be safely retried or repeated without concern for corrupting or altering the intended state. This increases robustness and fault tolerance in distributed or unreliable environments, as repeated operations have no adverse side effects.
4. **Atomicity Property for Reliability:** Enforcing the atomicity property ensures that side-loading operations are applied in their entirety or not at all. For example, if an operation fails partwayâ€”such as only the block headers are written but not the filter headersâ€”the system should roll back or recover to a consistent state. This guarantees that the system never ends up in a partially updated or inconsistent state, preserving data integrity and reliability even in the case of errors or failures during the operation.
5. **Chain Tip Consistency for Canonical State:** By requiring that the chain tip in both `header-index/bitcoin` and `header-index/regular` always reflects the best block hash (computed as the double SHA256 of the raw block header in little-endian), the system guarantees that all key indices and lookups are synchronized with the actual state of the chain. This prevents ambiguity about the tipâ€™s identity, ensures fast and reliable tip discovery, and provides a single source of truth for downstream components. The tip **must be updated** on every extending side-load to avoid stale state and to uphold the guarantees of atomic consistency.
